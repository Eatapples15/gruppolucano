
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>GeoJSON Merger - Sud Italia</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: #003366; border-bottom: 2px solid #003366; padding-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #003366; color: white; border: none; padding: 15px 25px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: #0055aa; }
        #status { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="container">
    <h2>Unificatore GeoJSON per Mappa Vigilanza</h2>
    <p>Inserisci gli URL <strong>RAW</strong> di GitHub dei tre file GeoJSON. Il tool estrarrà le <em>features</em> e creerà un unico file valido.</p>
    
    <div class="input-group">
        <label>URL GeoJSON Basilicata (Aree Allerta):</label>
        <input type="text" id="url-bas" placeholder="https://raw.githubusercontent.com/..." value="https://raw.githubusercontent.com/pcm-dpc/DPC-Bollettini-Criticita-Idrogeologica-Idraulica/master/geojson/aree_allerta.json">
        <small>Nota: Questo file contiene già tutte le zone d'Italia, lo filtreremo automaticamente.</small>
    </div>

    <div class="input-group">
        <label>URL GeoJSON Salerno (Comuni/Limiti):</label>
        <input type="text" id="url-sal" placeholder="https://raw.githubusercontent.com/..." value="https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_P_65_municipalities.geojson">
    </div>

    <div class="input-group">
        <label>URL GeoJSON Cosenza (Comuni/Limiti):</label>
        <input type="text" id="url-cos" placeholder="https://raw.githubusercontent.com/..." value="https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_P_78_municipalities.geojson">
    </div>

    <button onclick="mergeGeoJSON()">UNIFICA E SCARICA JSON</button>

    <div id="status"></div>
</div>

<script>
    async function mergeGeoJSON() {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = 'block';
        statusDiv.className = 'success';
        statusDiv.innerText = "Elaborazione in corso... attendere.";

        const urls = [
            document.getElementById('url-bas').value,
            document.getElementById('url-sal').value,
            document.getElementById('url-cos').value
        ];

        try {
            const responses = await Promise.all(urls.map(url => fetch(url).then(r => r.json())));
            
            let combinedFeatures = [];

            // 1. Processo Basilicata (Filtriamo solo BASILICATA dal file DPC)
            const basiFeatures = responses[0].features.filter(f => 
                f.properties.Nome_Reg && f.properties.Nome_Reg.toUpperCase() === "BASILICATA"
            );
            combinedFeatures.push(...basiFeatures);

            // 2. Processo Salerno (Aggiungiamo proprietà Nome_Reg per la mappa)
            responses[1].features.forEach(f => {
                f.properties.Nome_Reg = "CAMPANIA";
                combinedFeatures.push(f);
            });

            // 3. Processo Cosenza (Aggiungiamo proprietà Nome_Reg per la mappa)
            responses[2].features.forEach(f => {
                f.properties.Nome_Reg = "CALABRIA";
                combinedFeatures.push(f);
            });

            // Creazione GeoJSON finale
            const finalGeoJSON = {
                "type": "FeatureCollection",
                "features": combinedFeatures
            };

            // Download del file
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalGeoJSON));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "aree_allerta.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            statusDiv.className = 'success';
            statusDiv.innerText = "Successo! Il file 'aree_allerta.json' è stato scaricato. Caricalo nella tua repo GitHub.";

        } catch (error) {
            statusDiv.className = 'error';
            statusDiv.innerText = "Errore: " + error.message + ". Verifica gli URL o i permessi CORS.";
        }
    }
</script>

</body>
</html>
